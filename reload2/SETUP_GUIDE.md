# Complete System Setup Guide
## Admin Panel â†” Supabase â†” UI Dashboard

This guide walks you through setting up a fully connected real-time system.

---

## ğŸ“‹ Prerequisites

1. **Supabase Account**: https://supabase.com
2. **Node.js**: v18 or higher
3. **npm** or **bun**: Package manager

---

## ğŸš€ Quick Start (5 Steps)

### Step 1: Set Up Environment Variables

Create `.env.local` file in the project root:

```bash
# Required - Get from Supabase Dashboard â†’ Settings â†’ API
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here

# Required - Admin password (minimum 12 characters)
VITE_ADMIN_INITIAL_PASSWORD=YourSecurePassword123!
```

**Where to find Supabase credentials:**
1. Go to: https://supabase.com/dashboard/project/YOUR_PROJECT/settings/api
2. Copy "Project URL" â†’ `VITE_SUPABASE_URL`
3. Copy "anon public" key â†’ `VITE_SUPABASE_ANON_KEY`

---

### Step 2: Install Dependencies

```bash
npm install
# or
bun install
```

---

### Step 3: Create Database Tables

Go to Supabase Dashboard â†’ SQL Editor and run this:

```sql
-- ============================================
-- 1. EXECUTIVE METRICS TABLE
-- ============================================
CREATE TABLE IF NOT EXISTS executive_metrics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,

  -- Operational Metrics
  meals_delivered BIGINT NOT NULL DEFAULT 0,
  people_served BIGINT NOT NULL DEFAULT 0,
  cost_per_meal DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  program_efficiency DECIMAL(5,2) NOT NULL DEFAULT 0.00,
  coverage_governorates INTEGER NOT NULL DEFAULT 0,

  -- Financial Metrics
  revenue DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  expenses DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  reserves DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  cash_position DECIMAL(15,2) NOT NULL DEFAULT 0.00,

  -- Scenario Factors (JSON)
  scenario_factors JSONB DEFAULT '{}'::jsonb
);

-- Auto-update timestamp trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_executive_metrics_updated_at
  BEFORE UPDATE ON executive_metrics
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 2. USERS TABLE
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  role TEXT NOT NULL DEFAULT 'viewer' CHECK (role IN ('admin', 'viewer', 'editor')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  last_login TIMESTAMP WITH TIME ZONE
);

CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 3. AUDIT LOGS TABLE
-- ============================================
CREATE TABLE IF NOT EXISTS audit_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  action TEXT NOT NULL,
  table_name TEXT NOT NULL,
  record_id TEXT NOT NULL,
  old_data JSONB,
  new_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- ============================================
-- 4. SCENARIOS TABLE (Optional)
-- ============================================
CREATE TABLE IF NOT EXISTS scenarios (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  factors JSONB NOT NULL DEFAULT '{}'::jsonb,
  results JSONB,
  created_by UUID REFERENCES auth.users(id),
  is_active BOOLEAN DEFAULT true
);

CREATE TRIGGER update_scenarios_updated_at
  BEFORE UPDATE ON scenarios
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 5. ROW LEVEL SECURITY (RLS)
-- ============================================

-- Executive Metrics RLS
ALTER TABLE executive_metrics ENABLE ROW LEVEL SECURITY;

-- Anyone can read metrics
CREATE POLICY "Allow public read access"
  ON executive_metrics FOR SELECT
  USING (true);

-- Only authenticated users with admin role can modify
CREATE POLICY "Allow authenticated admin write"
  ON executive_metrics FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'admin'
    )
  );

-- Users RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Users can view their own data
CREATE POLICY "Users can view own data"
  ON users FOR SELECT
  USING (auth.uid() = id);

-- Admins can view all users
CREATE POLICY "Admins can view all users"
  ON users FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'admin'
    )
  );

-- Admins can manage users
CREATE POLICY "Admins can manage users"
  ON users FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'admin'
    )
  );

-- Audit Logs RLS
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Only admins can view audit logs
CREATE POLICY "Admins can view audit logs"
  ON audit_logs FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'admin'
    )
  );

-- Authenticated users can insert audit logs
CREATE POLICY "Authenticated users can log actions"
  ON audit_logs FOR INSERT
  TO authenticated
  WITH CHECK (user_id = auth.uid());

-- Scenarios RLS
ALTER TABLE scenarios ENABLE ROW LEVEL SECURITY;

-- Anyone can read active scenarios
CREATE POLICY "Allow read active scenarios"
  ON scenarios FOR SELECT
  USING (is_active = true);

-- Authenticated users can create scenarios
CREATE POLICY "Authenticated users can create scenarios"
  ON scenarios FOR INSERT
  TO authenticated
  WITH CHECK (created_by = auth.uid());

-- Users can update their own scenarios
CREATE POLICY "Users can update own scenarios"
  ON scenarios FOR UPDATE
  TO authenticated
  USING (created_by = auth.uid());

-- ============================================
-- 6. ENABLE REALTIME
-- ============================================
ALTER PUBLICATION supabase_realtime ADD TABLE executive_metrics;
ALTER PUBLICATION supabase_realtime ADD TABLE users;
ALTER PUBLICATION supabase_realtime ADD TABLE audit_logs;
ALTER PUBLICATION supabase_realtime ADD TABLE scenarios;

-- ============================================
-- 7. INSERT SAMPLE DATA
-- ============================================
INSERT INTO executive_metrics (
  meals_delivered,
  people_served,
  cost_per_meal,
  program_efficiency,
  revenue,
  expenses,
  reserves,
  cash_position,
  coverage_governorates,
  scenario_factors
) VALUES (
  367490721,
  4960000,
  6.36,
  83.00,
  2200000000.00,
  2316000000.00,
  731200000.00,
  459800000.00,
  27,
  '{
    "economicGrowth": 0,
    "inflationRate": 0,
    "donorSentiment": 0,
    "operationalEfficiency": 0,
    "foodPrices": 0,
    "unemploymentRate": 0,
    "corporateCSR": 0,
    "governmentSupport": 0,
    "exchangeRateEGP": 0,
    "logisticsCostIndex": 0,
    "regionalShock": 0
  }'::jsonb
)
ON CONFLICT DO NOTHING;
```

---

### Step 4: Create Admin User

**Option A: Using Supabase Dashboard (Recommended)**

1. Go to: Authentication â†’ Users
2. Click "Add User"
3. Email: `admin@example.com`
4. Password: Use the same password you set in `.env.local`
5. Click "Create User"
6. Go back to SQL Editor and run:

```sql
INSERT INTO users (id, email, role)
SELECT id, email, 'admin'
FROM auth.users
WHERE email = 'admin@example.com'
ON CONFLICT (id) DO UPDATE SET role = 'admin';
```

**Option B: Using Node Script**

```bash
npm run admin:create
# This runs the create-admin-user script
```

---

### Step 5: Start the Application

```bash
npm run dev
# or
bun dev
```

Visit:
- **Dashboard (Public)**: http://localhost:8080/
- **Admin Panel (Protected)**: http://localhost:8080/admin
- **Login Page**: http://localhost:8080/login

---

## ğŸ”„ How the System Works

### Real-Time Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Panel    â”‚
â”‚  /admin         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Admin updates metrics
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase DB   â”‚
â”‚   + Realtime    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Database triggers realtime event
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Dashboard   â”‚
â”‚  /dashboard     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   3. UI auto-updates
```

### Component Architecture

```
App.tsx
â”œâ”€â”€ Protected Routes (useAuth)
â”‚   â”œâ”€â”€ /admin â†’ AdminPanel
â”‚   â”‚   â””â”€â”€ useRealtimeMetrics()
â”‚   â”‚       â”œâ”€â”€ Load data
â”‚   â”‚       â”œâ”€â”€ Subscribe to changes
â”‚   â”‚       â””â”€â”€ Update Supabase
â”‚   â””â”€â”€ /login â†’ Login
â””â”€â”€ Public Routes
    â””â”€â”€ /dashboard â†’ ExecutiveDashboard
        â””â”€â”€ useRealtimeMetrics()
            â”œâ”€â”€ Load data
            â”œâ”€â”€ Subscribe to changes
            â””â”€â”€ Display updates
```

---

## ğŸ¯ Features

### âœ… Admin Panel Features

1. **Real-Time Sync**
   - All changes instantly sync to database
   - Live preview of changes
   - Auto-save functionality

2. **Full Metrics Control**
   - Operational metrics (meals, people served, etc.)
   - Financial metrics (revenue, expenses, reserves)
   - Scenario factors (11 different factors)
   - Coverage and efficiency data

3. **User Management**
   - View all users
   - Update user roles
   - Track last login

4. **Audit Logging**
   - Every change is logged
   - Who, what, when tracking
   - Old vs new data comparison

### âœ… Dashboard Features

1. **Real-Time Updates**
   - Instant updates when admin changes data
   - No page refresh needed
   - Live connection indicator

2. **Executive Metrics**
   - Financial health
   - Operational analytics
   - Impact metrics
   - Scenario modeling

3. **Interactive Charts**
   - Growth trajectories
   - Trend analysis
   - Comparison views

---

## ğŸ” Authentication Flow

```
User visits /admin
       â†“
Not authenticated? â†’ Redirect to /login
       â†“
Login with email/password
       â†“
Supabase auth.signInWithPassword()
       â†“
Success? â†’ Load user from users table
       â†“
Check role = 'admin'?
       â†“
Yes â†’ Access granted
No  â†’ Access denied
```

---

## ğŸ“¡ Testing Real-Time Sync

1. **Open Two Browser Windows:**
   - Window A: http://localhost:8080/admin (Admin Panel)
   - Window B: http://localhost:8080/dashboard (Dashboard)

2. **In Admin Panel (Window A):**
   - Change "Meals Delivered" from 367,490,721 to 400,000,000
   - Click "Save Changes"

3. **In Dashboard (Window B):**
   - Watch the metric update **instantly** without refresh
   - Connection indicator shows live status

---

## ğŸ› ï¸ Troubleshooting

### Issue: "Missing Supabase environment variables"

**Solution:**
```bash
# Check .env.local exists
ls .env.local

# Verify it contains required variables
cat .env.local

# Restart dev server
npm run dev
```

### Issue: "Login fails with correct credentials"

**Solution:**
1. Verify admin user exists in Supabase Auth
2. Verify user has 'admin' role in users table:
   ```sql
   SELECT * FROM users WHERE email = 'admin@example.com';
   ```
3. Check RLS policies are enabled

### Issue: "Metrics don't update in real-time"

**Solution:**
1. Check Realtime is enabled in Supabase:
   - Dashboard â†’ Database â†’ Replication
   - Ensure `supabase_realtime` publication includes tables

2. Verify browser console for connection:
   ```
   ğŸ“¡ Real-time metrics update received: {...}
   ```

3. Check network tab for WebSocket connection to Supabase

### Issue: "Access denied in Admin Panel"

**Solution:**
1. Verify user role:
   ```sql
   SELECT email, role FROM users WHERE email = 'admin@example.com';
   ```
2. Update role if needed:
   ```sql
   UPDATE users SET role = 'admin' WHERE email = 'admin@example.com';
   ```

---

## ğŸ“Š Database Schema

### executive_metrics
```typescript
{
  id: number;
  created_at: string;
  updated_at: string;
  meals_delivered: number;
  people_served: number;
  cost_per_meal: number;
  program_efficiency: number;
  revenue: number;
  expenses: number;
  reserves: number;
  cash_position: number;
  coverage_governorates: number;
  scenario_factors: {
    economicGrowth: number;
    inflationRate: number;
    // ... other factors
  };
}
```

### users
```typescript
{
  id: string; // UUID
  email: string;
  role: 'admin' | 'viewer' | 'editor';
  created_at: string;
  updated_at: string;
  last_login: string | null;
}
```

---

## ğŸ¨ Customization

### Add New Metric Fields

1. **Update Database:**
   ```sql
   ALTER TABLE executive_metrics
   ADD COLUMN new_metric DECIMAL(10,2) DEFAULT 0;
   ```

2. **Update TypeScript Type:**
   ```typescript
   // src/lib/supabase.ts
   export interface Database {
     executive_metrics: {
       Row: {
         // ... existing fields
         new_metric: number;
       };
     };
   }
   ```

3. **Add to Admin Panel:**
   ```typescript
   // src/components/AdminPanel.tsx
   <Input
     type="number"
     value={editMetrics.new_metric}
     onChange={(e) => setEditMetrics({
       ...editMetrics,
       new_metric: Number(e.target.value)
     })}
   />
   ```

---

## ğŸ”’ Security Checklist

- [âœ“] Service role key removed from client code
- [âœ“] RLS policies enabled on all tables
- [âœ“] Admin routes protected with authentication
- [âœ“] Passwords managed via environment variables
- [âœ“] `.env.local` in `.gitignore`
- [âœ“] Input validation on admin forms
- [âœ“] Audit logging for all changes
- [âœ“] CORS restricted to allowed origins
- [âœ“] Error messages sanitized in production

---

## ğŸ“š Additional Resources

- **Supabase Docs**: https://supabase.com/docs
- **React Query**: https://tanstack.com/query/latest
- **Realtime Guide**: https://supabase.com/docs/guides/realtime

---

## ğŸš€ Next Steps

1. âœ… Complete Step 1-5 above
2. âœ… Test real-time sync between admin and dashboard
3. âœ… Customize metrics and UI to your needs
4. Review `SECURITY_FIXES_REQUIRED.md` for production deployment
5. Set up monitoring and analytics
6. Configure backup and disaster recovery

---

**Need Help?**
Check the console for detailed error messages or review the troubleshooting section above.
